#cloud-config

users:
- name: ansible
  gecos: Ansible User
  groups: users,admin,wheel
  sudo: "ALL=(ALL) NOPASSWD:ALL"
  shell: /bin/bash
  lock_passwd: true
  ssh_authorized_keys:
    - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGsi4AEpzsL+XM2lbqaUHESHilYBvjPUm1dlqEtctarq"

locale: en_GB
timezone: Europe/London
keyboard:
  layout: gb

ssh_pwauth: false
allow_public_ssh_keys: true
disable_root: true
no_ssh_fingerprints: false
ssh:
  emit_keys_to_console: false

package_reboot_if_required: true
package_update: true
package_upgrade: true
packages:
  - qemu-guest-agent
  - wget
  - curl
  - git
  - nano
  - tmux

write_files:
- encoding: b64
  content: XFMKS2VybmVsIFxyIG9uIGFuIFxtCgpJUCBBZGRyZXNzOiBcNAoKVG9kYXkgaXMgXGQgXHQgQCBcbgo=
  owner: root:root
  path: /etc/issue
  permissions: '0644'

runcmd:
  - |
    # Get the OS ID from /etc/os-release
    OS_ID=$(grep -E "^ID=" /etc/os-release | cut -d'=' -f2 | tr -d '"')
    
    # Generate 6 random characters (alphanumeric)
    RANDOM_SUFFIX=$(openssl rand -hex 3)
    
    # Create the new hostname
    NEW_HOSTNAME="${OS_ID}-${RANDOM_SUFFIX}"
    
    # Set the hostname
    hostnamectl set-hostname "$NEW_HOSTNAME"
    
    # Update /etc/hostname file
    echo "$NEW_HOSTNAME" > /etc/hostname
    
    # Optional: Add to /etc/hosts for local resolution
    sed -i "s/127.0.0.1.*$/127.0.0.1 localhost.localdomain $NEW_HOSTNAME/" /etc/hosts
    